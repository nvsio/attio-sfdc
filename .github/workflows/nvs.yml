# =============================================================================
# NVS Bot - Mentionable PR Review Bot (Claude Code SDK)
# =============================================================================
# Mention @nvs-bot in any PR comment to trigger a review.
# Also runs automatically on PR open/sync.
# =============================================================================

name: NVS

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: nvs-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # CI Checks
  # ===========================================================================
  ci:
    name: CI
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      format: ${{ steps.checks.outputs.format }}
      clippy: ${{ steps.checks.outputs.clippy }}
      test: ${{ steps.checks.outputs.test }}
      build: ${{ steps.checks.outputs.build }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ci-${{ hashFiles('**/Cargo.lock') }}

      - name: Run checks
        id: checks
        run: |
          echo "format=pass" >> $GITHUB_OUTPUT
          cargo fmt --all -- --check || echo "format=fail" >> $GITHUB_OUTPUT

          echo "clippy=pass" >> $GITHUB_OUTPUT
          cargo clippy --all-targets -- -D warnings || echo "clippy=fail" >> $GITHUB_OUTPUT

          echo "test=pass" >> $GITHUB_OUTPUT
          cargo test --all-features || echo "test=fail" >> $GITHUB_OUTPUT

          echo "build=pass" >> $GITHUB_OUTPUT
          cargo build --release || echo "build=fail" >> $GITHUB_OUTPUT

  # ===========================================================================
  # NVS Bot - Triggered by @nvs-bot mention or PR events
  # ===========================================================================
  nvs-bot:
    name: NVS Bot
    runs-on: ubuntu-latest
    needs: [ci]
    if: |
      always() && (
        github.event_name == 'pull_request' ||
        (github.event_name == 'issue_comment' &&
         github.event.issue.pull_request &&
         contains(github.event.comment.body, '@nvs-bot'))
      )
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let pr;
            if (context.eventName === 'issue_comment') {
              const { data } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              pr = data;
            } else {
              pr = context.payload.pull_request;
            }
            core.setOutput('number', pr.number);
            core.setOutput('base', pr.base.ref);
            core.setOutput('head', pr.head.sha);
            core.setOutput('title', pr.title);
            core.setOutput('body', pr.body || '');

      - name: Get diff
        id: diff
        run: |
          git fetch origin ${{ steps.pr.outputs.base }}
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          git diff origin/${{ steps.pr.outputs.base }}...HEAD | head -5000 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only origin/${{ steps.pr.outputs.base }}...HEAD >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/sdk

      - name: NVS Review
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cat > review.mjs << 'EOF'
          import Anthropic from '@anthropic-ai/sdk';

          const client = new Anthropic();

          const pr = {
            title: process.env.PR_TITLE,
            body: process.env.PR_BODY,
            diff: process.env.PR_DIFF,
            files: process.env.PR_FILES,
            ci: process.env.CI_STATUS,
            mention: process.env.MENTION_CONTEXT
          };

          const prompt = `You are NVS, a helpful code review bot. Review this pull request.

          ${pr.mention ? `User mentioned you with: "${pr.mention}"` : 'Automatic review triggered.'}

          **PR: ${pr.title}**
          ${pr.body}

          **CI Status:**
          ${pr.ci}

          **Files Changed:**
          ${pr.files}

          **Diff:**
          \`\`\`diff
          ${pr.diff}
          \`\`\`

          Provide a concise review:
          1. **Summary**: What does this PR do? (1-2 sentences)
          2. **Review**: Key observations about code quality, security, tests
          3. **Verdict**: APPROVE, REQUEST_CHANGES, or COMMENT

          Keep it brief and actionable. Use bullet points.`;

          try {
            const response = await client.messages.create({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 2048,
              messages: [{ role: 'user', content: prompt }]
            });

            const review = response.content[0].text;
            console.log(JSON.stringify({ review }));
          } catch (error) {
            console.log(JSON.stringify({ review: `Review failed: ${error.message}` }));
          }
          EOF

          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo '{"review": "NVS is not configured. Add ANTHROPIC_API_KEY to repository secrets."}' > review.json
          else
            node review.mjs > review.json
          fi

        env:
          PR_TITLE: ${{ steps.pr.outputs.title }}
          PR_BODY: ${{ steps.pr.outputs.body }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
          PR_FILES: ${{ steps.diff.outputs.files }}
          CI_STATUS: |
            Format: ${{ needs.ci.outputs.format || 'skipped' }}
            Clippy: ${{ needs.ci.outputs.clippy || 'skipped' }}
            Tests: ${{ needs.ci.outputs.test || 'skipped' }}
            Build: ${{ needs.ci.outputs.build || 'skipped' }}
          MENTION_CONTEXT: ${{ github.event.comment.body }}

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let result;
            try {
              result = JSON.parse(fs.readFileSync('review.json', 'utf8'));
            } catch (e) {
              result = { review: 'Failed to parse review output.' };
            }

            const prNumber = ${{ steps.pr.outputs.number }};
            const isMention = '${{ github.event_name }}' === 'issue_comment';

            const body = `## NVS Bot

            ${result.review}

            ---
            <sub>Powered by Claude Code SDK | ${isMention ? 'Triggered by mention' : 'Automatic review'}</sub>`;

            // Find existing NVS comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body?.includes('## NVS Bot')
            );

            if (existing && !isMention) {
              // Update existing comment for automatic reviews
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

  # ===========================================================================
  # Gate - Required status check
  # ===========================================================================
  gate:
    name: NVS Gate
    runs-on: ubuntu-latest
    needs: [ci, nvs-bot]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Check status
        run: |
          if [[ "${{ needs.ci.result }}" == "failure" ]]; then
            echo "::error::CI failed"
            exit 1
          fi
          if [[ "${{ needs.nvs-bot.result }}" == "failure" ]]; then
            echo "::error::NVS review failed"
            exit 1
          fi
          echo "All checks passed"
